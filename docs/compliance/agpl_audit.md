# AGPL compliance audit

Date: 2026-02-23
Audited repo: `/Users/kasparsj/Work2/hydra/triode`
Upstream reference scanned: `/Users/kasparsj/Work2/hydra/hydra-synth`

This is an engineering compliance hardening pass, not legal advice.

## Summary

- `LICENSE` already contains the full GNU AGPL-3.0 text.
- `package.json` already declares `"license": "AGPL-3.0-only"`.
- The repo contains substantial upstream-derived Hydra/hydra-synth lineage in `src/` (same-path adapted files, plus renamed/adapted `triode-*` files).
- AGPL network-use source-offer UX has been made explicit in generated site output and playground UI via a visible `Source code` footer entry that can include exact commit SHA.
- Attribution/provenance artifacts were added and expanded (`NOTICE`, provenance headers, README license section, third-party license inventory report).

## What was found (evidence)

### 1) Upstream-derived code lineage (file-level)

Evidence comes from direct file comparisons between `triode/src` and `hydra-synth/src`.

- `src/eval-sandbox.js`: same-path derivative; diff against upstream shows small retained scaffold with triode changes (`1 file changed, 2 insertions(+), 67 deletions(-)`).
- `src/format-arguments.js`: same-path derivative (`1 file changed, 53 insertions(+), 97 deletions(-)`).
- `src/generate-glsl.js`: same-path derivative (`1 file changed, 86 insertions(+), 121 deletions(-)`).
- `src/generator-factory.js`: same-path derivative (`1 file changed, 64 insertions(+), 54 deletions(-)`).
- `src/glsl-source.js`: same-path derivative (`1 file changed, 95 insertions(+), 120 deletions(-)`).
- `src/glsl/glsl-functions.js`: same-path derivative (`1 file changed, 52 insertions(+), 315 deletions(-)`).
- `src/glsl/renderpass-functions.js`: same-path derivative (`1 file changed, 2 insertions(+), 2 deletions(-)`).
- `src/glsl/utility-functions.js`: same-path derivative (`1 file changed, 7 insertions(+), 107 deletions(-)`).
- `src/hydra-source.js`: same-path derivative with triode shim/compat behavior (`1 file changed, 160 insertions(+), 3 deletions(-)`).
- `src/hydra-synth.js`: same-path derivative reduced to compatibility shim (`1 file changed, 483 insertions(+), 3 deletions(-)` vs upstream runtime file).
- `src/index.js`: same-path derivative entrypoint alignment (`1 file changed, 4 insertions(+), 2 deletions(-)`).
- `src/lib/array-utils.js`: same-path derivative (`1 file changed, 3 insertions(+), 2 deletions(-)`).
- `src/lib/audio.js`: same-path derivative (`1 file changed, 1 insertion(+), 2 deletions(-)`).
- `src/lib/mouse-event.js`: same-path derivative (`1 file changed, 3 insertions(+), 3 deletions(-)`).
- `src/lib/sandbox.js`: same-path derivative (`1 file changed, 1 insertion(+), 1 deletion(-)`).
- `src/lib/video-recorder.js`: same-path derivative (`1 file changed, 2 insertions(+), 2 deletions(-)`).
- `src/output.js`: same-path derivative (`1 file changed, 96 insertions(+), 232 deletions(-)`).

Exact retained upstream-origin files found in this tree:

- `src/lib/easing-functions.js`: identical to upstream counterpart.
- `src/lib/mouse.js`: identical to upstream counterpart.
- `src/lib/screenmedia.js`: identical to upstream counterpart.
- `src/lib/webcam.js`: identical to upstream counterpart.

Renamed/adapted lineage evidence:

- `src/triode-synth.js`: adapted runtime with clear lineage to upstream `hydra-synth/src/hydra-synth.js`.
- `src/triode-source.js`: adapted source/media class with lineage to upstream `hydra-synth/src/hydra-source.js`.

### 2) Repository references to Hydra/AGPL lineage

Representative references found by full-repo keyword scan (`Hydra`, `hydra-synth`, `ojack`, `AGPL`, `Affero`, `GPL`):

- `README.md`: explicit Hydra compatibility and AGPL license statements.
- `CHANGELOG.md`: explicit reference to `hydra-synth` baseline.
- `docs/upstream-differences.md`: explicit repository-level upstream comparison and architecture divergence notes.
- `src/canvas.js`: explicit comment noting adaptation source (`hydra-extensions`).
- `package.json`: `author: "ojack"`, `license: "AGPL-3.0-only"`.

### 3) Deployment mode determination

From build/readme/scripts:

- Browser runtime with Vite (`vite.config.js`, `npm run dev`, `npm run build`).
- Static docs/examples/playground site generated by `scripts/site/build-site.mjs` and served from `site-dist/`.
- No dedicated long-running backend service entrypoint in this repository; typical network exposure is static web UI/pages.

## What was changed

### Attribution and provenance artifacts

- Added `NOTICE` with explicit Hydra/hydra-synth attribution, AGPL provenance statement, upstream links, and significant derived component paths.
- Added/updated provenance headers in key derived runtime/compiler files:
  - `src/triode-synth.js`
  - `src/triode-source.js`
  - `src/output.js`
  - `src/generator-factory.js`
  - `src/generate-glsl.js`
  - `src/glsl-source.js`
  - `src/format-arguments.js`
  - `src/eval-sandbox.js`

### AGPL metadata and docs

- Aligned lockfile root package license metadata in `package-lock.json` to `AGPL-3.0-only`.
- Added `NOTICE` to npm package allowlist so packaged artifacts include attribution metadata:
  - `package.json`
- Expanded README license section to `License (AGPL-3.0)` with explicit source-obtain instructions and hosted-source-link guidance:
  - `README.md`

### AGPL network-use source offer (UI)

Implemented visible `Source code` offer in typical hosted UIs:

- Generated docs/examples layout now includes a footer source offer with repo link, AGPL label, version, and commit label:
  - `scripts/site/build-site.mjs`
  - `site/static/site.css`
- Playground UI now includes visible source footer link:
  - `site/playground/index.html`
- Site build now supports commit-accurate source offer links using env vars (`TRIODE_GIT_SHA`, `GIT_SHA`, `GITHUB_SHA`) with local git fallback:
  - `scripts/site/build-site.mjs`

### Dependency/license hygiene

- Added inventory report for direct deps + lockfile scan and risk flags:
  - `docs/compliance/third_party_licenses.md`

## Commit-by-commit PR plan

Planned commit sequence (implemented as working-tree changes in this pass):

1. `compliance: add upstream attribution and AGPL audit artifacts`
- Add `NOTICE`
- Add `docs/compliance/agpl_audit.md`

2. `compliance: add AGPL network source offer in hosted UI`
- Update `scripts/site/build-site.mjs` for footer source offer + commit metadata injection
- Update `site/playground/index.html` source-offer footer
- Update `site/static/site.css` footer link styling

3. `compliance: align metadata and provenance markers`
- Update `package-lock.json` root license to `AGPL-3.0-only`
- Add provenance headers in key derived files listed above
- Expand `README.md` `License (AGPL-3.0)` section

4. `compliance: add third-party dependency license inventory`
- Add `docs/compliance/third_party_licenses.md`

## Remaining risks / follow-ups

- Lockfile metadata gap: `docs/compliance/third_party_licenses.md` reports 104 lockfile entries without explicit `license` fields; these should be verified from package artifacts before high-assurance release workflows.
- Non-hydra vendored/derived assets (for example controls implementations or bundled GUI assets) should continue to retain upstream licensing notices where applicable; current pass focused on Hydra/hydra-synth lineage and AGPL source-offer clarity.
- If triode is embedded into third-party hosted UIs outside this repositoryâ€™s generated site, operators should keep a visible `Source code` link for the running build revision to satisfy AGPL network-use expectations.

## Verification

- Executed `npm run ci:check` successfully on 2026-02-23.
- Checks passed: release metadata, docs sync/coverage/snippet/link checks, eslint, typecheck, production build, site build, smoke tests, and `npm pack --dry-run`.
- `site:build` output confirms source-offer wiring with commit-aware link (example run output included `Source offer: https://github.com/kasparsj/triode/tree/<sha> (v1.0.0 (<short-sha>))`).
